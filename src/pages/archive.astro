---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = (await getCollection('posts')).sort((a, b) => {
  const pinnedDelta = Number(Boolean(b.data.pinned)) - Number(Boolean(a.data.pinned));
  if (pinnedDelta !== 0) return pinnedDelta;
  return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
});

const groups = new Map();
for (const post of posts) {
  const year = post.data.pubDate.getFullYear();
  const month = String(post.data.pubDate.getMonth() + 1).padStart(2, '0');
  const key = `${year}-${month}`;
  if (!groups.has(key)) {
    groups.set(key, { year, month, posts: [] });
  }
  groups.get(key).posts.push(post);
}

const formatDate = (date) =>
  new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).format(date);
---

<BaseLayout title="归档">
  <section class="mx-auto max-w-[720px] px-6 pb-16">
    <div class="mb-10">
      <h1 class="text-2xl font-semibold tracking-tight">归档</h1>
      <p class="mt-3 text-sm leading-7 text-zinc-500 dark:text-zinc-400">
        按月份查看文章。
      </p>
    </div>
    <div class="space-y-10">
      {Array.from(groups.values()).map((group) => (
        <section>
          <h2 class="text-sm font-medium text-zinc-400 dark:text-zinc-500">
            {group.year} 年 {group.month} 月
          </h2>
          <div class="mt-4 space-y-4">
            {group.posts.map((post) => (
              <article class="group">
                <a href={`/posts/${post.slug}/`} class="post-link block">
                  <div class="text-xs text-zinc-400 dark:text-zinc-500">
                    {formatDate(post.data.pubDate)}
                  </div>
                  <h3 class="post-title mt-1 text-base font-medium text-zinc-900 transition-colors group-hover:text-zinc-700 dark:text-zinc-100 dark:group-hover:text-zinc-200">
                    {post.data.title}
                  </h3>
                  <p class="mt-2 text-sm leading-7 text-zinc-500 dark:text-zinc-400">
                    {post.data.description}
                  </p>
                </a>
              </article>
            ))}
          </div>
        </section>
      ))}
    </div>
  </section>
</BaseLayout>
